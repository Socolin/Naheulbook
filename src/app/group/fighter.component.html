<div class="fighter-container"
     [class.combat-row-selected]="selected"
     (click)="selectFighter()">

    <div class="field-icon">
        <monster-color-selector *ngIf="fighter.isMonster"
                                [monster]="fighter.monster"
                                (onNumberChange)='changeNumber(fighter, $event)'
                                (onColorChange)='changeColor(fighter, $event)'>
        </monster-color-selector>
        <character-color-selector *ngIf="!fighter.isMonster"
                                  [character]="fighter.character"
                                  (onColorChange)='changeColor(fighter, $event)'>
        </character-color-selector>
    </div>

    <div class="field-datas">
        <div class="row-first-part">
            <div>
                <div class="field-name">{{fighter.name}}</div>
                <div class="field text-attack">{{fighter.stats.at}}</div>
                <div class="field"><span class="text-prd">{{fighter.stats.prd}}</span></div>
                <div class="field"><span class="text-esq">{{fighter.stats.esq}}</span></div>
                <div class="field-large" [class.text-danger]="fighter.stats.ev < 4">
                    <value-editor [title]="'Energie vitale'"
                                  [value]="fighter.stats.ev"
                                  [maxValue]="fighter.stats.maxEv"
                                  (onChange)="changeStat('ev', $event)">
                    </value-editor>
                </div>
                <div class="field-large">
                <span *ngIf="fighter.stats.maxEa">
                    <value-editor [title]="'Energie astrale'"
                                  [value]="fighter.stats.ea"
                                  [maxValue]="fighter.stats.maxEa"
                                  (onChange)="changeStat('ea', $event)">
                    </value-editor>
                </span>
                    <span *ngIf="!fighter.stats.maxEa">-</span>
                </div>
                <div class="field-medium">{{fighter.stats.pr}}({{fighter.stats.pr_magic}})</div>
                <div class="field">
                    {{fighter.stats.resm}}
                </div>
            </div>
            <div>
                <div style="display: flex; justify-content: flex-start">
                    <target-selector [fighter]=fighter
                                     [targets]=fighters
                                     (onTargetChange)='changeTarget($event)'>
                    </target-selector>
                </div>
            </div>
        </div>
        <div class="row-damage-part">
            <div *ngFor="let dmg of fighter.stats.dmg" class="equiped-weapons-damages">
                <mat-icon *ngIf="dmg.incompatible" color="warn">warning</mat-icon>
                <span>
                    <span [class.incompatible-item]="dmg.incompatible">
                        {{dmg.damage}}
                    </span>
                    <span class="secondary-text damage-weapon-name"  [class.incompatible-item]="dmg.incompatible">
                        {{dmg.name}}
                    </span>
                </span>
            </div>
        </div>
        <div class="row-end-part">
            <div class="field">{{fighter.stats.cou}}</div>
            <div class="field-fixed-small">
                <mat-checkbox [checked]="fighter.chercheNoise"
                              (change)="changeStat('chercheNoise', $event.checked)"
                              [disabled]="fighter.isCharacter">
                </mat-checkbox>
            </div>
        </div>
    </div>

    <div *ngIf="!fighter.isMonster" class="field-button">
        <button mat-icon-button [matMenuTriggerFor]="menuCharacter" aria-label="Open basic menu">
            <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #menuCharacter="matMenu">
            <button mat-menu-item
                    (click)="displayCharacterSheet(fighter.character)">
                Voir la fiche
            </button>
            <button mat-menu-item
                    (click)=addItemTo(fighter)>
                Ajouter un objet
            </button>
        </mat-menu>
    </div>
    <div *ngIf="fighter.isMonster" class="field-button">
        <button mat-icon-button [matMenuTriggerFor]="menuMonster" aria-label="Open basic menu">
            <mat-icon>more_vert</mat-icon>
        </button>

        <mat-menu #menuMonster="matMenu">
            <button mat-menu-item
                    (click)=killMonster(fighter.monster)>
                Tuer le monstre
            </button>
            <button mat-menu-item
                    (click)=deleteMonster(fighter.monster)>
                Supprimer le monstre
            </button>
            <button mat-menu-item
                    (click)=openEditMonsterDialog()>
                Modifier
            </button>
        </mat-menu>
    </div>
</div>

<div class="row-stat-modifiers">
    <mat-card class="expanded-data-card"
             [class.combat-row-selected]="selected"
             *ngIf="expandedView && fighter.isMonster">
        <mat-card-subtitle>Informations complémentaires</mat-card-subtitle>
        <mat-card-content class="expanded-data">
            <div class="fighter-advanced-datas">
                <div class="fighter-advanced-data">
                    <span class="label">XP</span>
                    <span class="value">
                        <value-editor [value]="fighter.monster.data.xp"
                                      [title]="'XP'"
                                      (onChange)="updateMonsterField(fighter.monster, 'xp', $event)">
                        </value-editor>
                    </span>
                </div>
                <div class="fighter-advanced-data">
                    <span class="label">Sexe</span>
                    <span class="value">
                        <mat-form-field>
                            <mat-select [ngModel]="fighter.monster.data.sex" (ngModelChange)="updateMonsterField(fighter.monster, 'sex', $event)">
                                <mat-option [value]="null">
                                    Non défini
                                </mat-option>
                                <mat-option [value]="'f'">
                                    Femme
                                </mat-option>
                                <mat-option [value]="'h'">
                                    Homme
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </span>
                </div>
                <div class="fighter-advanced-data" *ngIf="fighter.monster.data.page">
                    <span class="label">Page</span>
                    <span class="value">{{fighter.monster.data.page}}</span>
                </div>

                <mat-form-field class="fighter-note">
                <textarea matInput
                          matTextareaAutosize
                          matAutosizeMinRows="2"
                          placeholder="Note"
                          [ngModel]="fighter.monster.data.note"
                          (blur)="updateMonsterField(fighter.monster, 'note', $event.target.value)">
                </textarea>
                </mat-form-field>
            </div>
        </mat-card-content>
    </mat-card>

    <mat-card class="expanded-data-card"
             [class.combat-row-selected]="selected"
             *ngIf="expandedView && fighter.isMonster">
        <mat-card-subtitle>Effets</mat-card-subtitle>
        <mat-card-content class="monster-effects">
            <div class="effect-list">
                <ng-template ngFor let-modifier [ngForOf]="fighter.monster.modifiers" let-i="index" let-last="last">
                    <div *ngIf="!modifier.permanent"
                         class="effect-element"
                         (click)="selectModifier(modifier)"
                         [class.selected]="selectedModifier === modifier">
                        <span *ngIf="modifier.reusable" class="toggle-reusable">
                            <mat-slide-toggle color="primary"
                                             (change)="toggleReusableModifier(modifier)"
                                             (click)="$event.stopPropagation()"
                                             [ngModel]="modifier.active">
                            </mat-slide-toggle>
                        </span>
                        <span class="padding">
                            {{modifier.name}}
                        </span>
                        <span *ngIf="modifier.currentCombatCount">
                            <span class="ra ra-sword duration-icon"></span> {{modifier.currentCombatCount}}
                        </span>
                        <span *ngIf="modifier.currentTimeDuration">
                            <span class="ra ra-clockwork duration-icon"></span> {{modifier.currentTimeDuration | nhbkShortDuration}}
                        </span>
                        <span *ngIf="modifier.currentLapCount">
                            <span class="game-icon game-icon-clockwise-rotation duration-icon"></span> {{modifier.currentLapCount}}
                        </span>
                    </div>
                    <mat-card *ngIf="selectedModifier === modifier"
                         class="effect-detail"
                         [class.selected]="selectedModifier === modifier">
                        <button mat-button color="accent"
                                class="delete-modifier-button"
                                (click)="removeModifier(modifier)">
                            SUPPRIMER
                        </button>
                        <div class="secondary-text" *ngIf="modifier.type">{{modifier.type}}</div>
                        <div *ngIf="modifier.description">{{modifier.description}}</div>
                        <div class="effect-total-duration">
                            <span [ngSwitch]="modifier.durationType">
                                <ng-template [ngSwitchCase]="'lap'">
                                    Durée totale: {{modifier.lapCount | i18nPlural: ({'=1': '# tour', 'other': '# tours'})}}
                                </ng-template>
                                <ng-template [ngSwitchCase]="'combat'">
                                    Durée totale: {{modifier.combatCount | i18nPlural: ({'=1': '# combat', 'other': '# combats'})}}
                                </ng-template>
                                <ng-template [ngSwitchCase]="'time'">
                                    Durée totale: {{modifier.timeDuration | nhbkDuration}}
                                </ng-template>
                            </span>
                        </div>
                        <div class="effect-duration">
                            Durée:
                            <span [ngSwitch]="modifier.durationType">
                                <ng-template [ngSwitchCase]="'lap'">
                                    {{modifier.currentLapCount | i18nPlural: ({'=1': '# tour', 'other': '# tours'})}}
                                </ng-template>
                                <ng-template [ngSwitchCase]="'combat'">
                                    {{modifier.currentCombatCount | i18nPlural: ({'=1': '# combat', 'other': '# combats'})}}
                                </ng-template>
                                <ng-template [ngSwitchCase]="'custom'">
                                    {{modifier.duration}}
                                </ng-template>
                                <ng-template [ngSwitchCase]="'time'">
                                    {{modifier.currentTimeDuration | nhbkDuration}}
                                </ng-template>
                                <ng-template [ngSwitchCase]="'forever'">
                                    permanent
                                </ng-template>
                            </span>
                        </div>

                        <div *ngIf="modifier.values && modifier.values.length">
                            Effet:
                            <div class="effect-modifier" *ngFor="let modifier of modifier.values">
                                {{modifier | modifier}}
                            </div>
                        </div>
                    </mat-card>
                </ng-template>
                <button mat-icon-button (click)="openAddEffectDialog()">
                    <mat-icon>add</mat-icon>
                </button>
            </div>
        </mat-card-content>
    </mat-card>

</div>

<div class="row-inventory" *ngIf="expandedView && fighter.isMonster">
    <mat-card class="expanded-data-card"
             [class.combat-row-selected]="selected">
        <mat-card-subtitle>Inventaire</mat-card-subtitle>
        <mat-card-content class="expanded-data">
            <div class="fighter-advanced-datas">
                <div>
                    <div *ngFor="let item of fighter.monster.items"
                         class="fighter-inventory-item"
                         matRipple
                         [class.selected]="selectedItem === item"
                         (click)="selectedItem = item">
                        <mat-slide-toggle class="equip-toggle"
                                         *ngIf="item.template.slots && item.template.slots.length"
                                         [ngModel]="item.data.equiped"
                                         (change)="equipItem(item, $event)">
                        </mat-slide-toggle>
                        <icon [icon]="item.data.icon" [size]="'24px'"></icon>
                        <span *ngIf="item.template.data.quantifiable">{{item.data.quantity}} </span>
                        {{item.data.name}}
                    </div>
                    <button mat-icon-button (click)="addItemTo(fighter)">
                        <mat-icon>add</mat-icon>
                    </button>
                </div>
            </div>
        </mat-card-content>
    </mat-card>
    <div class="item-detail" *ngIf="selectedItem">
        <item-detail [gmView]="true" [character]="fighter.character" [item]="selectedItem" [readonly]="true">
        </item-detail>
    </div>
</div>

<div class="row-inventory" *ngIf="expandedView && !fighter.isMonster">
    <mat-card class="expanded-data-card"
             [class.combat-row-selected]="selected">
        <mat-card-content class="expanded-data">
            <div class="fighter-advanced-datas">
            <mat-tab-group>
                <mat-tab label="Équipé">
                    <div *ngFor="let item of fighter.character.items"
                         [class.selected]="selectedItem === item">
                        <span *ngIf="item.data.equiped && itemHasSlot(item.template, 'WEAPON')"
                              class="fighter-inventory-item"
                              matRipple
                              (click)="selectedItem = item">
                            <mat-icon *ngIf="item.computedData.incompatible" color="warn">warning</mat-icon>
                            <icon [icon]="item.data.icon" [size]="'24px'"></icon>
                            <span *ngIf="item.template.data.quantifiable">{{item.data.quantity}}&nbsp;</span>
                            {{item.data.name}}
                        </span>
                        <span
                            *ngIf="item.data.equiped && !itemHasSlot(item.template, 'WEAPON') && !item.template.data.container"
                            class="fighter-inventory-item"
                            matRipple
                            (click)="selectedItem = item">
                            <mat-icon *ngIf="item.computedData.incompatible" color="warn">warning</mat-icon>
                            <icon [icon]="item.data.icon" [size]="'24px'"></icon>
                            <span *ngIf="item.template.data.quantifiable">{{item.data.quantity}}&nbsp;</span>
                            {{item.data.name}}
                        </span>
                    </div>
                </mat-tab>
                <mat-tab *ngIf="fighter.character.computedData.notIdentifiedItems.length"
                         label="Non identifié ({{fighter.character.computedData.notIdentifiedItems.length}})">
                    <div *ngFor="let item of fighter.character.computedData.notIdentifiedItems"
                         [class.selected]="selectedItem === item">
                        <span class="fighter-inventory-item"
                              matRipple
                              (click)="selectedItem = item">
                            <icon [icon]="item.data.icon" [size]="'24px'"></icon>
                            <span *ngIf="item.template.data.quantifiable">{{item.data.quantity}}&nbsp;</span>
                            {{item.data.name}}
                        </span>
                    </div>
                </mat-tab>
            </mat-tab-group>
            </div>
        </mat-card-content>
    </mat-card>
    <div class="item-detail" *ngIf="selectedItem">
        <item-detail [gmView]="true"
                     [character]="fighter.character"
                     [item]="selectedItem"
                     [readonly]="true">
        </item-detail>
    </div>
</div>

<ng-template #editMonsterDialog="cdkPortal" cdk-portal>
    <mat-card>
        <mat-card-content>
            <div class="editable-data">
                <div class="fighter-row">
                    <mat-form-field class="name">
                        <input matInput
                               placeholder="Nom"
                               [ngModel]="fighter.monster.name"
                               (ngModelChange)="changeStat('name', $event)"
                        />
                    </mat-form-field>
                </div>
            </div>
            <div class="fighter-row">
                <div class="at">
                    AT:
                    <span class="text-attack">
                        <value-editor [value]="fighter.monster.data.at"
                                      [title]="'AT'"
                                      (onChange)="updateMonsterField(fighter.monster, 'at', $event)">
                        </value-editor>
                    </span>
                </div>
                <div class="prd">
                    PRD:
                    <span class="text-prd">
                        <value-editor [value]="fighter.monster.data.prd"
                                      [title]="'Parade'"
                                      (onChange)="updateMonsterField(fighter.monster, 'prd', $event)">
                        </value-editor>
                    </span>
                </div>
                <div class="esq">
                    ESQ:
                    <span class="text-esq">
                        <value-editor [value]="fighter.monster.data.esq"
                                      [title]="'Esquive'"
                                      (onChange)="updateMonsterField(fighter.monster, 'esq', $event)">
                        </value-editor>
                    </span>
                </div>
                <div class="pr">
                    PR:
                    <span class="">
                        <value-editor [value]="fighter.monster.data.pr"
                                      [title]="'Protection'"
                                      (onChange)="updateMonsterField(fighter.monster, 'pr', $event)">
                        </value-editor>
                    </span>
                </div>
                <div class="pr_magic">
                    PR Ma:
                    <span class="">
                        <value-editor [value]="fighter.monster.data.pr_magic"
                                      [title]="'Protection magique'"
                                      (onChange)="updateMonsterField(fighter.monster, 'pr_magic', $event)">
                        </value-editor>
                    </span>
                </div>
                <div class="resm">
                    RESM:
                    <span class="">
                        <value-editor [value]="fighter.monster.data.resm"
                                      [title]="'Resistance Magique'"
                                      (onChange)="updateMonsterField(fighter.monster, 'resm', $event)">
                        </value-editor>
                    </span>
                </div>
            </div>
            <div class="fighter-row">
                <mat-form-field class="dmg">
                    <input matInput
                           placeholder="Dmg"
                           [ngModel]="fighter.monster.data.dmg"
                           (ngModelChange)="changeStat('dmg', $event)"
                    />
                </mat-form-field>
                <div class="cou">
                    COU:
                    <value-editor [value]="fighter.monster.data.cou"
                                  [title]="'Courage'"
                                  (onChange)="updateMonsterField(fighter.monster, 'cou', $event)">
                    </value-editor>
                </div>
                <div class="cherchenoise">
                    Chercher des noises:
                    <mat-checkbox [checked]="fighter.monster.data.chercheNoise"
                                 (change)="updateMonsterField(fighter.monster, 'chercheNoise', $event.checked)">
                    </mat-checkbox>
                </div>
            </div>
        </mat-card-content>
    </mat-card>
</ng-template>
