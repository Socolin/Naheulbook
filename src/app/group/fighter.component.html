<div class="fighter">
    <div class="icon">
        <monster-color-selector *ngIf="fighter.isMonster"
                                [monster]="fighter.monster"
                                (onNumberChange)='changeNumber(fighter, $event)'
                                (onColorChange)='changeColor(fighter, $event)'>
        </monster-color-selector>
        <character-color-selector *ngIf="!fighter.isMonster"
                                  [character]="fighter.character"
                                  (onColorChange)='changeColor(fighter, $event)'>
        </character-color-selector>
    </div>

    <div class="name">
        <span>{{fighter.name}}</span>
        <ng-template [ngIf]="fighter.isCharacter">
            <button mat-icon-button [matMenuTriggerFor]="menuCharacter" aria-label="Ouvrir le menu du personnage">
                <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menuCharacter="matMenu">
                <button mat-menu-item
                        (click)="displayCharacterSheet()">
                    <mat-icon>pageview</mat-icon>
                    Voir la fiche
                </button>
                <button mat-menu-item
                        (click)=openAddItemDialog()>
                    <mat-icon>add</mat-icon>
                    Objet
                </button>
                <button mat-menu-item
                        (click)=openAddGemDialog()>
                    <mat-icon>add</mat-icon>Pierre précieuse
                </button>
            </mat-menu>
        </ng-template>
        <ng-template [ngIf]="fighter.isMonster">
            <button mat-icon-button [matMenuTriggerFor]="menuMonster" aria-label="Open basic menu">
                <mat-icon>more_vert</mat-icon>
            </button>

            <mat-menu #menuMonster="matMenu">
                <button mat-menu-item
                        (click)=openEditMonsterDialog()>
                    <mat-icon>edit</mat-icon>
                    Modifier
                </button>
                <button mat-menu-item
                        (click)=openAddItemDialog()>
                    <mat-icon>add</mat-icon>
                    Objet
                </button>
                <button mat-menu-item
                        (click)=openAddGemDialog()>
                    <mat-icon>add</mat-icon>Pierre précieuse
                </button>
                <button mat-menu-item
                        (click)=openAddEffectDialog()>
                    <mat-icon>add</mat-icon>Modificateur
                </button>
                <button mat-menu-item
                        (click)=openInventoryDialog()>
                    <mat-icon fontSet="game-icon" fontIcon="game-icon-battle-gear" class="ra-mat-button-icon-24"></mat-icon>
                    <span [matBadge]="fighter.monster?.items?.length || undefined" matBadgeOverlap="false">Inventaire</span>
                </button>
                <button mat-menu-item
                        (click)=killMonster(fighter.monster)>
                    <mat-icon fontSet="game-icon" fontIcon="game-icon-tombstone" class="ra-mat-button-icon-24"></mat-icon>
                    Tuer le monstre
                </button>
                <button mat-menu-item [matMenuTriggerFor]="deleteMonsterConfirm">
                    <mat-icon>delete</mat-icon>
                    Supprimer le monstre
                </button>
            </mat-menu>

            <mat-menu #deleteMonsterConfirm="matMenu">
                <button mat-menu-item
                        (click)=deleteMonster(fighter.monster)>
                    Confirmer
                </button>
            </mat-menu>
        </ng-template>
    </div>

    <div class="field-with-label at">
        <span class="label" matTooltip="Attaque">AT:</span>
        <span class="text-attack">{{fighter.stats.at}}</span>
    </div>
    <div class="field-with-label prd">
        <span class="label" matTooltip="Parade">PRD:</span>
        <span class="text-prd">{{fighter.stats.prd}}</span>
    </div>
    <div class="field-with-label esq">
        <span class="label" matTooltip="Esquive">ESQ:</span>
        <span class="text-esq">{{fighter.stats.esq}}</span>
    </div>
    <div class="field-with-label ev" [class.text-danger]="fighter.stats.ev < 4">
        <span class="label" matTooltip="Énergie vitale">EV:</span>
        <value-editor [title]="'Energie vitale'"
                      [value]="fighter.stats.ev"
                      [maxValue]="fighter.stats.maxEv"
                      (onChange)="changeStat('ev', $event)">
        </value-editor>
    </div>
    <div class="field-with-label ea">
        <span class="label" matTooltip="Énergie astrale">EA:</span>
        <span *ngIf="fighter.stats.maxEa">
            <value-editor [title]="'Energie astrale'"
                          [value]="fighter.stats.ea"
                          [maxValue]="fighter.stats.maxEa"
                          (onChange)="changeStat('ea', $event)">
            </value-editor>
        </span>
        <span *ngIf="!fighter.stats.maxEa">-</span>
    </div>
    <div class="field-with-label pr">
        <span class="label" matTooltip="Armure (Armure magique)">PR:</span>
        {{fighter.stats.pr}}({{fighter.stats.pr_magic}})
    </div>
    <div class="field-with-label resm">
        <span class="label" matTooltip="Resistance magique">RESM:</span>
        {{fighter.stats.resm}}
    </div>
    <div class="field-with-label cou">
        <span class="label" matTooltip="Courage">COU:</span>
        <span *ngIf="fighter.chercheNoise" matTooltip="Chercher des noise">
            {{fighter.stats.cou}}+
        </span>
        <span *ngIf="!fighter.chercheNoise">
            {{fighter.stats.cou}}
        </span>
    </div>

    <div class="dmg" matTooltip="Dégats">
        <div *ngFor="let dmg of fighter.stats.dmg" class="equiped-weapons-damages">
            <mat-icon *ngIf="dmg.incompatible" color="warn">warning</mat-icon>
            <span>
                    <div [class.incompatible-item]="dmg.incompatible">
                        {{dmg.damage}}
                    </div>
                    <div class="secondary-text damage-weapon-name"  [class.incompatible-item]="dmg.incompatible">
                        {{dmg.name}}
                    </div>
                </span>
        </div>
    </div>
    <div class="effects" *ngIf="fighter.isMonster && fighter.monster.modifiers?.length">
        Effets:
        <div *ngFor="let modifier of fighter.monster.modifiers" class="effect">
            <span class="effect-name">
                <span class="effect-reusable" *ngIf="modifier.reusable">
                    <mat-slide-toggle color="primary"
                                      (change)="toggleReusableModifier(modifier)"
                                      (click)="$event.stopPropagation()"
                                      [ngModel]="modifier.active">
                    </mat-slide-toggle>
                </span>
                {{modifier.name}}
            </span>
            <span *ngIf="modifier.currentCombatCount" class="effect-time">
                <span class="ra ra-sword duration-icon"></span> {{modifier.currentCombatCount}}
            </span>
            <span *ngIf="modifier.currentTimeDuration" class="effect-time">
                <span class="ra ra-clockwork duration-icon"></span> {{modifier.currentTimeDuration | nhbkShortDuration}}
            </span>
            <span *ngIf="modifier.currentLapCount" class="effect-time">
                <span class="game-icon game-icon-clockwise-rotation duration-icon"></span> {{modifier.currentLapCount}}
            </span>
            <span class="effect-actions">
               <button mat-icon-button [matMenuTriggerFor]="menuCharacter"
                       aria-label="Ouvrir le menu de l'effet">
                    <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #menuCharacter="matMenu">
                    <button mat-menu-item
                            (click)="openModifierDetails(modifier)">
                        <mat-icon>info</mat-icon>
                        Details
                    </button>
                    <button mat-menu-item
                            (click)="removeModifier(modifier)">
                        <mat-icon>delete</mat-icon>
                        Supprimer
                    </button>
                </mat-menu>
            </span>
        </div>
    </div>
    <div class="note" *ngIf="fighter.isMonster && fighter.monster.data.note">
        Note: {{fighter.monster.data.note}}
    </div>
</div>

<!--

<div class="fighter-container"
     [class.combat-row-selected]="selected"
     (click)="selectFighter()">

    <div class="field-icon">
        <monster-color-selector *ngIf="fighter.isMonster"
                                [monster]="fighter.monster"
                                (onNumberChange)='changeNumber(fighter, $event)'
                                (onColorChange)='changeColor(fighter, $event)'>
        </monster-color-selector>
        <character-color-selector *ngIf="!fighter.isMonster"
                                  [character]="fighter.character"
                                  (onColorChange)='changeColor(fighter, $event)'>
        </character-color-selector>
    </div>

    <div class="field-datas">
        <div class="row-first-part">
            <div>
                <div class="field-name">{{fighter.name}}</div>
                <div class="field text-attack">{{fighter.stats.at}}</div>
                <div class="field"><span class="text-prd">{{fighter.stats.prd}}</span></div>
                <div class="field"><span class="text-esq">{{fighter.stats.esq}}</span></div>
                <div class="field-large" [class.text-danger]="fighter.stats.ev < 4">
                    <value-editor [title]="'Energie vitale'"
                                  [value]="fighter.stats.ev"
                                  [maxValue]="fighter.stats.maxEv"
                                  (onChange)="changeStat('ev', $event)">
                    </value-editor>
                </div>
                <div class="field-large">
                <span *ngIf="fighter.stats.maxEa">
                    <value-editor [title]="'Energie astrale'"
                                  [value]="fighter.stats.ea"
                                  [maxValue]="fighter.stats.maxEa"
                                  (onChange)="changeStat('ea', $event)">
                    </value-editor>
                </span>
                    <span *ngIf="!fighter.stats.maxEa">-</span>
                </div>
                <div class="field-medium">{{fighter.stats.pr}}({{fighter.stats.pr_magic}})</div>
                <div class="field">
                    {{fighter.stats.resm}}
                </div>
            </div>
            <div>
                <div style="display: flex; justify-content: flex-start">
                    <target-selector [fighter]=fighter
                                     [targets]=fighters
                                     (onTargetChange)='changeTarget($event)'>
                    </target-selector>
                </div>
            </div>
        </div>
        <div class="row-damage-part">
            <div *ngFor="let dmg of fighter.stats.dmg" class="equiped-weapons-damages">
                <mat-icon *ngIf="dmg.incompatible" color="warn">warning</mat-icon>
                <span>
                    <span [class.incompatible-item]="dmg.incompatible">
                        {{dmg.damage}}
                    </span>
                    <span class="secondary-text damage-weapon-name"  [class.incompatible-item]="dmg.incompatible">
                        {{dmg.name}}
                    </span>
                </span>
            </div>
        </div>
        <div class="row-end-part">
            <div class="field">{{fighter.stats.cou}}</div>
            <div class="field-fixed-small">
                <mat-checkbox [checked]="fighter.chercheNoise"
                              (change)="changeStat('chercheNoise', $event.checked)"
                              [disabled]="fighter.isCharacter">
                </mat-checkbox>
            </div>
        </div>
    </div>

    <div *ngIf="!fighter.isMonster" class="field-button">
        <button mat-icon-button [matMenuTriggerFor]="menuCharacter" aria-label="Open basic menu">
            <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #menuCharacter="matMenu">
            <button mat-menu-item
                    (click)="displayCharacterSheet(fighter.character)">
                Voir la fiche
            </button>
            <button mat-menu-item
                    (click)=addItemTo(fighter)>
                Ajouter un objet
            </button>
        </mat-menu>
    </div>
    <div *ngIf="fighter.isMonster" class="field-button">
        <button mat-icon-button [matMenuTriggerFor]="menuMonster" aria-label="Open basic menu">
            <mat-icon>more_vert</mat-icon>
        </button>

        <mat-menu #menuMonster="matMenu">
            <button mat-menu-item
                    (click)=killMonster(fighter.monster)>
                Tuer le monstre
            </button>
            <button mat-menu-item
                    (click)=deleteMonster(fighter.monster)>
                Supprimer le monstre
            </button>
            <button mat-menu-item
                    (click)=openEditMonsterDialog()>
                Modifier
            </button>
        </mat-menu>
    </div>
</div>

<div class="row-stat-modifiers">
    <mat-card class="expanded-data-card"
             [class.combat-row-selected]="selected"
             *ngIf="expandedView && fighter.isMonster">
        <mat-card-subtitle>Informations complémentaires</mat-card-subtitle>
        <mat-card-content class="expanded-data">
            <div class="fighter-advanced-datas">
                <div class="fighter-advanced-data">
                    <span class="label">XP</span>
                    <span class="value">
                        <value-editor [value]="fighter.monster.data.xp"
                                      [title]="'XP'"
                                      (onChange)="updateMonsterField(fighter.monster, 'xp', $event)">
                        </value-editor>
                    </span>
                </div>
                <div class="fighter-advanced-data">
                    <span class="label">Sexe</span>
                    <span class="value">
                        <mat-form-field>
                            <mat-select [ngModel]="fighter.monster.data.sex" (ngModelChange)="updateMonsterField(fighter.monster, 'sex', $event)">
                                <mat-option [value]="null">
                                    Non défini
                                </mat-option>
                                <mat-option [value]="'f'">
                                    Femme
                                </mat-option>
                                <mat-option [value]="'h'">
                                    Homme
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </span>
                </div>
                <div class="fighter-advanced-data" *ngIf="fighter.monster.data.page">
                    <span class="label">Page</span>
                    <span class="value">{{fighter.monster.data.page}}</span>
                </div>

                <mat-form-field class="fighter-note">
                <textarea matInput
                          matTextareaAutosize
                          matAutosizeMinRows="2"
                          placeholder="Note"
                          [ngModel]="fighter.monster.data.note"
                          (blur)="updateMonsterField(fighter.monster, 'note', $event.target.value)">
                </textarea>
                </mat-form-field>
            </div>
        </mat-card-content>
    </mat-card>

    <mat-card class="expanded-data-card"
             [class.combat-row-selected]="selected"
             *ngIf="expandedView && fighter.isMonster">
        <mat-card-subtitle>Effets</mat-card-subtitle>
        <mat-card-content class="monster-effects">
            <div class="effect-list">
                <ng-template ngFor let-modifier [ngForOf]="fighter.monster.modifiers" let-i="index" let-last="last">
                    <div *ngIf="!modifier.permanent"
                         class="effect-element"
                         (click)="selectModifier(modifier)"
                         [class.selected]="selectedModifier === modifier">
                        <span *ngIf="modifier.reusable" class="toggle-reusable">
                            <mat-slide-toggle color="primary"
                                             (change)="toggleReusableModifier(modifier)"
                                             (click)="$event.stopPropagation()"
                                             [ngModel]="modifier.active">
                            </mat-slide-toggle>
                        </span>
                        <span class="padding">
                            {{modifier.name}}
                        </span>
                        <span *ngIf="modifier.currentCombatCount">
                            <span class="ra ra-sword duration-icon"></span> {{modifier.currentCombatCount}}
                        </span>
                        <span *ngIf="modifier.currentTimeDuration">
                            <span class="ra ra-clockwork duration-icon"></span> {{modifier.currentTimeDuration | nhbkShortDuration}}
                        </span>
                        <span *ngIf="modifier.currentLapCount">
                            <span class="game-icon game-icon-clockwise-rotation duration-icon"></span> {{modifier.currentLapCount}}
                        </span>
                    </div>
                    <mat-card *ngIf="selectedModifier === modifier"
                         class="effect-detail"
                         [class.selected]="selectedModifier === modifier">
                        <button mat-button color="accent"
                                class="delete-modifier-button"
                                (click)="removeModifier(modifier)">
                            SUPPRIMER
                        </button>
                        <div class="secondary-text" *ngIf="modifier.type">{{modifier.type}}</div>
                        <div *ngIf="modifier.description">{{modifier.description}}</div>
                        <div class="effect-total-duration">
                            <span [ngSwitch]="modifier.durationType">
                                <ng-template [ngSwitchCase]="'lap'">
                                    Durée totale: {{modifier.lapCount | i18nPlural: ({'=1': '# tour', 'other': '# tours'})}}
                                </ng-template>
                                <ng-template [ngSwitchCase]="'combat'">
                                    Durée totale: {{modifier.combatCount | i18nPlural: ({'=1': '# combat', 'other': '# combats'})}}
                                </ng-template>
                                <ng-template [ngSwitchCase]="'time'">
                                    Durée totale: {{modifier.timeDuration | nhbkDuration}}
                                </ng-template>
                            </span>
                        </div>
                        <div class="effect-duration">
                            Durée:
                            <span [ngSwitch]="modifier.durationType">
                                <ng-template [ngSwitchCase]="'lap'">
                                    {{modifier.currentLapCount | i18nPlural: ({'=1': '# tour', 'other': '# tours'})}}
                                </ng-template>
                                <ng-template [ngSwitchCase]="'combat'">
                                    {{modifier.currentCombatCount | i18nPlural: ({'=1': '# combat', 'other': '# combats'})}}
                                </ng-template>
                                <ng-template [ngSwitchCase]="'custom'">
                                    {{modifier.duration}}
                                </ng-template>
                                <ng-template [ngSwitchCase]="'time'">
                                    {{modifier.currentTimeDuration | nhbkDuration}}
                                </ng-template>
                                <ng-template [ngSwitchCase]="'forever'">
                                    permanent
                                </ng-template>
                            </span>
                        </div>

                        <div *ngIf="modifier.values && modifier.values.length">
                            Effet:
                            <div class="effect-modifier" *ngFor="let modifier of modifier.values">
                                {{modifier | modifier}}
                            </div>
                        </div>
                    </mat-card>
                </ng-template>
                <button mat-icon-button (click)="openAddEffectDialog()">
                    <mat-icon>add</mat-icon>
                </button>
            </div>
        </mat-card-content>
    </mat-card>

</div>

<div class="row-inventory" *ngIf="expandedView && fighter.isMonster">
    <mat-card class="expanded-data-card"
             [class.combat-row-selected]="selected">
        <mat-card-subtitle>Inventaire</mat-card-subtitle>
        <mat-card-content class="expanded-data">
            <div class="fighter-advanced-datas">
                <div>
                    <div *ngFor="let item of fighter.monster.items"
                         class="fighter-inventory-item"
                         matRipple
                         [class.selected]="selectedItem === item"
                         (click)="selectedItem = item">
                        <mat-slide-toggle class="equip-toggle"
                                         *ngIf="item.template.slots && item.template.slots.length"
                                         [ngModel]="item.data.equiped"
                                         (change)="equipItem(item, $event)">
                        </mat-slide-toggle>
                        <icon [icon]="item.data.icon" [size]="'24px'"></icon>
                        <span *ngIf="item.template.data.quantifiable">{{item.data.quantity}} </span>
                        {{item.data.name}}
                    </div>
                    <button mat-icon-button (click)="addItemTo(fighter)">
                        <mat-icon>add</mat-icon>
                    </button>
                </div>
            </div>
        </mat-card-content>
    </mat-card>
    <div class="item-detail" *ngIf="selectedItem">
        <item-detail [gmView]="true" [character]="fighter.character" [item]="selectedItem" [readonly]="true">
        </item-detail>
    </div>
</div>

<div class="row-inventory" *ngIf="expandedView && !fighter.isMonster">
    <mat-card class="expanded-data-card"
             [class.combat-row-selected]="selected">
        <mat-card-content class="expanded-data">
            <div class="fighter-advanced-datas">
            <mat-tab-group>
                <mat-tab label="Équipé">
                    <div *ngFor="let item of fighter.character.items"
                         [class.selected]="selectedItem === item">
                        <span *ngIf="item.data.equiped && itemHasSlot(item.template, 'WEAPON')"
                              class="fighter-inventory-item"
                              matRipple
                              (click)="selectedItem = item">
                            <mat-icon *ngIf="item.computedData.incompatible" color="warn">warning</mat-icon>
                            <icon [icon]="item.data.icon" [size]="'24px'"></icon>
                            <span *ngIf="item.template.data.quantifiable">{{item.data.quantity}}&nbsp;</span>
                            {{item.data.name}}
                        </span>
                        <span
                            *ngIf="item.data.equiped && !itemHasSlot(item.template, 'WEAPON') && !item.template.data.container"
                            class="fighter-inventory-item"
                            matRipple
                            (click)="selectedItem = item">
                            <mat-icon *ngIf="item.computedData.incompatible" color="warn">warning</mat-icon>
                            <icon [icon]="item.data.icon" [size]="'24px'"></icon>
                            <span *ngIf="item.template.data.quantifiable">{{item.data.quantity}}&nbsp;</span>
                            {{item.data.name}}
                        </span>
                    </div>
                </mat-tab>
                <mat-tab *ngIf="fighter.character.computedData.notIdentifiedItems.length"
                         label="Non identifié ({{fighter.character.computedData.notIdentifiedItems.length}})">
                    <div *ngFor="let item of fighter.character.computedData.notIdentifiedItems"
                         [class.selected]="selectedItem === item">
                        <span class="fighter-inventory-item"
                              matRipple
                              (click)="selectedItem = item">
                            <icon [icon]="item.data.icon" [size]="'24px'"></icon>
                            <span *ngIf="item.template.data.quantifiable">{{item.data.quantity}}&nbsp;</span>
                            {{item.data.name}}
                        </span>
                    </div>
                </mat-tab>
            </mat-tab-group>
            </div>
        </mat-card-content>
    </mat-card>
    <div class="item-detail" *ngIf="selectedItem">
        <item-detail [gmView]="true"
                     [character]="fighter.character"
                     [item]="selectedItem"
                     [readonly]="true">
        </item-detail>
    </div>
</div>

-->
