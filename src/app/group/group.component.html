<div class="group-component-container">
<div class="usefull-data">
    <usefull-data (onAction)="usefullDataAction($event)"></usefull-data>
</div>
<div *ngIf="loadingGroup" class="loading">
    <mat-spinner></mat-spinner>
</div>
<div *ngIf="group && !loadingGroup" class="group-container">
    <mat-tab-group (selectedTabChange)=selectTab($event) [selectedIndex]="currentTabIndex">
        <mat-tab label="Infos">
            <div class="info-tab">
                <mat-card>
                    <mat-card-title>{{group.name}}
                    </mat-card-title>
                    <dl>
                        <dt>Mankdebol</dt>
                        <dd>
                            <value-editor [value]="group.data.mankdebol"
                                          [title]="'Mankdebol du groupe'"
                                          (onChange)="changeGroupValue('mankdebol', $event)">
                            </value-editor>
                        </dd>

                        <dt>Débilibeuk</dt>
                        <dd>
                            <value-editor [value]="group.data.debilibeuk"
                                          [title]="'Débilibeuk du groupe'"
                                          (onChange)="changeGroupValue('debilibeuk', $event)">
                            </value-editor>
                        </dd>

                        <dt>Date</dt>
                        <dd>
                            <date-selector [date]="group.data.date"
                                           (onChange)="changeGroupValue('date', $event)">
                            </date-selector>
                            <date-modifier *ngIf="group.data.date"
                                           [title]="'Modification de la date'"
                                           (onChange)="addTime($event)">
                            </date-modifier>
                            <date [date]="group.data.date"></date>
                        </dd>

                        <dt>Lieu</dt>
                        <dd>
                            <autocomplete-input [value]="group.location.name"
                                                (onSelect)="changeGroupLocation($event)"
                                                [(callback)]="autocompleteLocationsCallback">
                            </autocomplete-input>
                        </dd>
                    </dl>
                </mat-card>
                <mat-card>
                    <mat-card-title>Évènements</mat-card-title>
                    <mat-card-content>
                        <events #events [group]="group"></events>
                    </mat-card-content>
                    <mat-card-actions align="end">
                        <button mat-button
                                [disabled]="group.data?.date == null"
                                color="primary"
                                (click)="events.openAddEventDialog()">
                            AJOUTER UN ÉVÈNEMENT
                        </button>
                    </mat-card-actions>
                </mat-card>
            </div>
        </mat-tab>

        <mat-tab label="Personnages">
            <div class="characters-tab">
                <mat-card>
                    <mat-card-title>Joueurs</mat-card-title>
                    <mat-card-content class="characters-cards">
                        <ng-template ngFor let-character [ngForOf]="group.characters">
                            <mat-card *ngIf="!character.isNpc" class="character-summary-card">
                                <mat-card-header>
                                    <mat-card-title>{{character.name}} - Lvl{{character.level}}</mat-card-title>
                                    <mat-card-subtitle>
                                        {{character.origin.name}}
                                        <span *ngIf="character.jobs"> -</span>
                                        <span *ngFor="let job of character.jobs">
                                            &nbsp;{{job.name}}
                                        </span>
                                    </mat-card-subtitle>
                                    <button mat-icon-button [matMenuTriggerFor]="characterActions">
                                        <mat-icon>more_vert</mat-icon>
                                    </button>
                                    <mat-menu xPosition="before" #characterActions="matMenu">
                                        <button mat-menu-item
                                                (click)="displayCharacterSheet(character)">
                                            Voir la fiche
                                        </button>
                                        <button mat-menu-item
                                                *ngIf="character.user && character.user !== _loginService.currentLoggedUser.id"
                                                (click)="takeOwnership(character)">
                                            Devenir propriétaire
                                        </button>
                                        <button mat-menu-item
                                                *ngIf="!character.user || character.user === _loginService.currentLoggedUser.id"
                                                (click)="openChangeOwnershipDialog(character)">
                                            Définir le propriétaire
                                        </button>
                                        <button mat-menu-item
                                                (click)="kickCharacter(character)">
                                            Retirer du groupe
                                        </button>
                                    </mat-menu>
                                </mat-card-header>
                                <mat-card-actions align="end">
                                    <button
                                        mat-button
                                        color="primary"
                                        *ngIf="!character.active"
                                        (click)="toggleActiveCharacter(character)">
                                        ACTIVER
                                    </button>
                                    <button
                                        mat-button
                                        *ngIf="character.active"
                                        color="accent"
                                        (click)="toggleActiveCharacter(character)">
                                        DESACTIVER
                                    </button>
                                </mat-card-actions>
                            </mat-card>
                        </ng-template>
                    </mat-card-content>
                    <mat-card-actions align="end">
                        <button mat-button
                                color="primary"
                                (click)="activeAllCharacter(false)">
                            DESACTIVER TOUS
                        </button>
                        <button mat-button
                                color="primary"
                                (click)="activeAllCharacter(true)">
                            ACTIVER TOUS
                        </button>
                    </mat-card-actions>
                </mat-card>

                <mat-card>
                    <mat-card-title>PNJs</mat-card-title>
                    <mat-card-content class="characters-cards">
                        <ng-template ngFor let-character [ngForOf]="group.characters">
                            <mat-card *ngIf="character.isNpc" class="character-summary-card">
                                <mat-card-header>
                                    <mat-card-title>{{character.name}}</mat-card-title>
                                    <mat-card-subtitle>{{character.origin.name}}
                                        <span *ngIf="character.job"> - {{character.job.name}} </span> - Lvl{{character.level}}
                                    </mat-card-subtitle>
                                </mat-card-header>
                                <mat-card-actions align="end">
                                    <button
                                        mat-button
                                        color="primary"
                                        *ngIf="!character.active"
                                        (click)="toggleActiveCharacter(character)">
                                        ACTIVER
                                    </button>
                                    <button
                                        mat-button
                                        *ngIf="character.active"
                                        color="accent"
                                        (click)="toggleActiveCharacter(character)">
                                        DESACTIVER
                                    </button>
                                </mat-card-actions>
                            </mat-card>
                        </ng-template>
                    </mat-card-content>
                    <mat-card-actions align="end">
                        <button mat-button
                                color="primary"
                                (click)="createNpc()">
                            AJOUTER PNJ
                        </button>
                    </mat-card-actions>
                </mat-card>
                <mat-card>
                    <mat-card-title>Invitations</mat-card-title>
                    <mat-card-content>
                        <div *ngIf="group.invites.length">
                            <h4>Invitation à valider</h4>
                            <div class="list-group">
                                <ng-template ngFor let-invite [ngForOf]="group.invites">
                                    <mat-expansion-panel>
                                        <mat-expansion-panel-header>
                                            <mat-panel-description>{{invite.origin}} <span *ngIf="invite.jobs && invite.jobs.length">- {{invite.jobs.join()}}</span></mat-panel-description>
                                            <mat-panel-title>{{invite.name}}</mat-panel-title>
                                        </mat-expansion-panel-header>
                                        <mat-action-row>
                                            <button mat-button (click)="cancelInvite(invite)">REFUSER</button>
                                            <button mat-button (click)="acceptInvite(invite)">ACCEPTER</button>
                                        </mat-action-row>
                                    </mat-expansion-panel>
                                </ng-template>
                            </div>
                            <hr>
                        </div>
                        <div *ngIf="group.invited.length">
                            <h4>Invitation en attente</h4>
                            <div class="list-group">
                                <ng-template ngFor let-invite [ngForOf]="group.invited">
                                    <mat-expansion-panel>
                                        <mat-expansion-panel-header>
                                            <mat-panel-description>{{invite.origin}} <span *ngIf="invite.jobs && invite.jobs.length">- {{invite.jobs.join()}}</span></mat-panel-description>
                                            <mat-panel-title>{{invite.name}}</mat-panel-title>
                                        </mat-expansion-panel-header>
                                        <mat-action-row>
                                            <button mat-button (click)="cancelInvite(invite)">ANNULER</button>
                                        </mat-action-row>
                                    </mat-expansion-panel>
                                </ng-template>
                            </div>
                            <hr>
                        </div>
                    </mat-card-content>
                    <mat-card-actions align="end">
                        <button mat-button
                                (click)="openInviteCharacterModal()"
                                color="primary">
                            INVITER UN JOUEUR
                        </button>
                    </mat-card-actions>
                </mat-card>
            </div>
        </mat-tab>

        <mat-tab label="Combat">
            <div class="combat-tab-header">
                <button mat-raised-button
                        color="primary"
                        *ngIf="!group?.data?.inCombat"
                        (click)="startCombat()">
                    Debut combat
                </button>
                <button mat-raised-button
                        color="primary"
                        *ngIf="group.data.inCombat"
                        (click)="endCombat()">
                    Fin combat
                </button>
                <button mat-raised-button
                        color="primary"
                        (click)="fighterPanel.openAddMonsterDialog()">
                    Ajouter un monstre
                </button>
                <button mat-raised-button
                        color="primary"
                        (click)="fighterPanel.openDeadMonstersDialog()">
                    Monstres morts
                </button>
            </div>

            <fighter-panel #fighterPanel [group]="group"></fighter-panel>
        </mat-tab>

        <mat-tab label="Loot">
            <group-loot-panel [group]="group"></group-loot-panel>
        </mat-tab>

        <mat-tab label="Historique">
            <group-history [group]="group"></group-history>
        </mat-tab>
    </mat-tab-group>
</div>
</div>

<div *ngIf="group">
    <ng-template ngFor let-character [ngForOf]="group.characters">
        <ng-template *ngIf="character.active" #characters="cdkPortal" cdk-portal>
            <div class="character-sheet">
                <mat-card>
                    <mat-card-title>
                        {{character.name}}
                        <button mat-button color="primary" (click)="closeCharacterSheet()">FERMER</button>
                    </mat-card-title>
                    <mat-card-content>
                        <character [character]="character"></character>
                    </mat-card-content>
                </mat-card>
            </div>
        </ng-template>
    </ng-template>
</div>


<!-- Modal -->
<ng-template #changeOwnershipDialog="cdkPortal" cdk-portal>
    <mat-card class="change-ownership-dialog">
        <mat-card-title>Définir le propriétaire</mat-card-title>
        <mat-card-subtitle>{{selectedCharacter?.name}}</mat-card-subtitle>
        <mat-card-content>
            <div class="modal-body">
                <mat-form-field>
                    <input matInput
                           placeholder="Chercher un utilisateur"
                           type="text"
                           [(ngModel)]="filterSearchUser"
                           (ngModelChange)="updateSearchUser()" />
                </mat-form-field>
                <div *ngIf="!filteredUsers.length">
                    Aucun utilisateur trouvé
                </div>
                <mat-radio-group [(ngModel)]="changeOwnershipNewOwner">
                    <ng-template ngFor let-user [ngForOf]="filteredUsers">
                        <mat-radio-button [value]="user">
                            {{user.displayName}}
                        </mat-radio-button>
                    </ng-template>
                </mat-radio-group>
            </div>
        </mat-card-content>
        <mat-card-actions align="end">
            <button mat-button
                    (click)="closeChangeOwnershipDialog()"
                    color="primary">
                ANNULER
            </button>
            <button mat-button
                    (click)="changeOwnershipConfirm()"
                    color="primary">
                VALIDER
            </button>
        </mat-card-actions>
    </mat-card>
</ng-template>

<ng-template #inviteCharacterModal="cdkPortal" cdk-portal>
    <mat-card class="invite-character-modal">
        <mat-card-title>Inviter un personnage</mat-card-title>
        <mat-card-content>
            <mat-form-field>
                <input matInput
                       [(ngModel)]="searchNameInvite"
                       (ngModelChange)="updateFilteredPlayer()"
                       placeholder="Nom du personnage"/>
            </mat-form-field>

            <div *ngIf="!filteredInvitePlayers?.length">
                Aucun personnage trouvé
            </div>


            <mat-radio-group [(ngModel)]="selectedInviteCharacter">
                <ng-template ngFor let-character [ngForOf]="filteredInvitePlayers">
                    <mat-radio-button [value]="character" class="element">
                        <strong>{{character.name}}</strong> {{character.origin}} - {{character.owner}}
                    </mat-radio-button>
                </ng-template>
            </mat-radio-group>
        </mat-card-content>
        <mat-card-actions align="end">
            <button mat-button
                    (click)="closeInviteCharacterModal()"
                    color="primary">
                ANNULER
            </button>
            <button mat-button
                    color="primary"
                    (click)="inviteCharacter(selectedInviteCharacter)">
                INVITER
            </button>
        </mat-card-actions>
    </mat-card>
</ng-template>

<add-effect-modal #addEffectModal (createModifier)="selectCustomModifier($event)">
</add-effect-modal>

<fighter-selector #fighterSelector [group]="group" (selectFighters)="onSelectFighters($event)">
</fighter-selector>

<create-item #createItemModal (onAddItem)="onItemAdded($event)"></create-item>
